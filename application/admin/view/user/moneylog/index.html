<div class="panel panel-default panel-intro">
    {:build_heading()}

    <!-- ========== 修改标识 - 会员余额日志页面 ========== -->
    <div class="alert alert-info" style="margin: 10px;">
        <i class="fa fa-info-circle"></i> 
        <strong>页面已修改</strong> - 会员余额日志管理页面 - 已优化加载速度
    </div>

    <div class="panel-body">
        <div id="myTabContent" class="tab-content">
            <div class="tab-pane fade active in" id="one">
                <div class="widget-body no-padding">
                    <div id="toolbar" class="toolbar">
                        <a href="javascript:;" class="btn btn-primary btn-refresh" title="{:__('Refresh')}" ><i class="fa fa-refresh"></i> </a>
                        <a href="javascript:;" class="btn btn-info btn-load-data" title="加载最新数据" ><i class="fa fa-download"></i> 加载数据</a>
                        <!--<a href="javascript:;" class="btn btn-success btn-add {:$auth->check('user/moneylog/add')?'':'hide'}" title="{:__('Add')}" ><i class="fa fa-plus"></i> {:__('Add')}</a>
                        <a href="javascript:;" class="btn btn-success btn-edit btn-disabled disabled {:$auth->check('user/moneylog/edit')?'':'hide'}" title="{:__('Edit')}" ><i class="fa fa-pencil"></i> {:__('Edit')}</a>-->
                        <!--<a href="javascript:;" class="btn btn-danger btn-del btn-disabled disabled {:$auth->check('user/moneylog/del')?'':'hide'}" title="{:__('Delete')}" ><i class="fa fa-trash"></i> {:__('Delete')}</a>-->
                    </div>
                    
                    <!-- 数据加载状态提示 -->
                    <div id="loading-status" class="alert alert-warning" style="margin: 10px; display: none;">
                        <i class="fa fa-spinner fa-spin"></i> 正在加载数据，请稍候...
                    </div>
                    
                    <table id="table" class="table table-striped table-bordered table-hover table-nowrap"
                           data-operate-edit="{:$auth->check('user/moneylog/edit')}"
                           data-operate-del="{:$auth->check('user/moneylog/del')}"
                           width="100%">
                    </table>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
$(function() {
    // 页面加载完成后，先显示框架，不查询数据
    var table = $('#table').bootstrapTable({
        url: '{:url("user/moneylog/index")}?init=1',
        method: 'post',
        toolbar: '#toolbar',
        pagination: true,
        pageSize: 20,
        pageList: [10, 20, 50],
        search: true,
        showColumns: true,
        showRefresh: false,
        commonSearch: false,
        columns: [
            {field: 'user_id', title: '会员ID', sortable: true},
            {field: 'money', title: '变更金额', sortable: true},
            {field: 'before', title: '变更前余额', sortable: true},
            {field: 'after', title: '变更后余额', sortable: true},
            {field: 'memo', title: '备注', sortable: true},
            {field: 'createtime', title: '创建时间', sortable: true}
        ]
    });
    
    // 点击加载数据按钮
    $('.btn-load-data').click(function() {
        loadData();
    });
    
    // 加载数据函数
    function loadData() {
        $('#loading-status').show();
        $('.btn-load-data').addClass('disabled');
        
        // 重新设置表格URL，加载真实数据
        table.bootstrapTable('refresh', {
            url: '{:url("user/moneylog/index")}',
            method: 'post'
        });
        
        // 数据加载完成后隐藏状态提示
        setTimeout(function() {
            $('#loading-status').hide();
            $('.btn-load-data').removeClass('disabled');
        }, 2000);
    }
    
    // 分页时自动加载数据
    $('#table').on('page-change.bs.table', function() {
        if (table.bootstrapTable('getData').length > 0) {
            loadData();
        }
    });
});
</script>
