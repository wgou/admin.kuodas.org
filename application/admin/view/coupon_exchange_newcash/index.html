<style>
    /* Style for the full-screen loading overlay */
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.8);
        /* Semi-transparent white background */
        z-index: 9999;
    }

    .loader {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        border: 8px solid #f3f3f3;
        /* Light gray border */
        border-top: 8px solid #3498db;
        /* Blue border on top */
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        /* Rotate animation */
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
    
    .modal-footer {
        padding: 9px;
        text-align: right;
        border-top: 1px solid #e5e5e5;
    }
</style>

<div class="panel panel-default panel-intro">

    <div class="panel-heading">
        {:build_heading(null,FALSE)}
        <ul class="nav nav-tabs" data-field="status">
            <li class="{:$Think.get.status === null ? 'active' : ''}"><a href="#t-all" data-value=""
                    data-toggle="tab">{:__('All')}</a></li>
            {foreach name="statusList" item="vo"}
            <li class="{:$Think.get.status === (string)$key ? 'active' : ''}"><a href="#t-{$key}" data-value="{$key}"
                    data-toggle="tab">{$vo}</a></li>
            {/foreach}
        </ul>
    </div>


    <div class="panel-body">
        <div id="myTabContent" class="tab-content">
            <div class="tab-pane fade active in" id="one">
                <div class="widget-body no-padding">
                    <div id="toolbar" class="toolbar">
                        <a href="javascript:;" class="btn btn-primary btn-refresh" title="{:__('Refresh')}"><i
                                class="fa fa-refresh"></i> </a>
                        <a href="javascript:;"
                            class="btn btn-success btn-edit btn-disabled disabled {:$auth->check('coupon_exchange_newcash/edit')?'':'hide'}"
                            title="{:__('Edit')}"><i class="fa fa-pencil"></i> {:__('Edit')}</a>
                        <a href="javascript:;"
                            class="btn btn-danger btn-del btn-disabled disabled {:$auth->check('coupon_exchange_newcash/del')?'':'hide'}"
                            title="{:__('Delete')}"><i class="fa fa-trash"></i> {:__('Delete')}</a>
                        <a href="javascript:;" class="btn btn-info btn-multiple btn-disabled disabled"
                            data-toggle="modal" data-target="#exampleModal" title="{:__('批量处理')}"><i
                                class="fa fa-check-circle-o"></i> {:__('批量处理')}</a>
                        <div class="btn-group">
                            <button type="button" class="btn btn-warning dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <i class="fa fa-bolt"></i> 一键处理 <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a href="javascript:;" onclick="autoApproveAll(1)"><i class="fa fa-check text-success"></i> 一键通过所有待审核</a></li>
                                <li><a href="javascript:;" onclick="autoApproveAll(0)"><i class="fa fa-times text-danger"></i> 一键驳回所有待审核</a></li>
                            </ul>
                        </div>
                    </div>
                    <table id="table" class="table table-striped table-bordered table-hover table-nowrap"
                        data-operate-edit="{:$auth->check('coupon_exchange_newcash/edit')}"
                        data-operate-del="{:$auth->check('coupon_exchange_newcash/del')}" width="100%">
                    </table>
                </div>
            </div>

        </div>
    </div>
    
    <div id="loading-overlay" class="loading-overlay">
        <div class="loader"></div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document" style="width: 400px;">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="margin-bottom: -20px;">
                    <form method="POST" action="">
                        <div class="form-group row">
                            <label for="colFormLabelSm"
                                class="col-sm-2 col-form-label col-form-label-sm">{:__('Status')}:</label>
                            <div id="colFormLabel" class="col-sm-10">

                                {foreach name="approveList" item="vo"}
                                <label for="status-{$key}"><input id="status-{$key}" name="status" type="radio"
                                        value="{$key}" {in name="key" value="1" }checked{/in} />
                                    {$vo}</label>
                                {/foreach}

                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="submit_data()">{:__('OK')}</button>
                </div>
            </div>
        </div>
    </div>
    
    
</div>

<script>
    function getIdSelections() {
        return $.map($("#table").bootstrapTable('getSelections'), function (row) {
            return row.id
        });
    };
    function submit_data() {
        $('#exampleModal').modal('hide');
        $('#loading-overlay').show();
        var checkids = [];
        checkids = getIdSelections();
        console.log(checkids);
        var order_status = $('input[name="status"]:checked').val();
        var requestData = {
            ids: checkids,
            status: order_status
        };
        $.ajax({
            type: 'POST',
            url: 'coupon_exchange_newcash/approve',
            data: requestData,
            success: function (data) {
                $('#table').bootstrapTable('refresh');
                $('#loading-overlay').hide();
            },
            error: function (xhr, status, error) {
                console.error('Error:', xhr.responseText);
                // Handle errors here
            }
        });
    }

    function showProgressDialog() {
        var progressHtml = `
            <div class="modal fade" id="progressModal" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title">批量处理进度</h4>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>批次大小（条/批）：</label>
                                <select id="batchSizeSelect" class="form-control">
                                    <option value="10">10条/批（适合低配置服务器）</option>
                                    <option value="25">25条/批</option>
                                    <option value="50" selected>50条/批（推荐）</option>
                                    <option value="100">100条/批</option>
                                    <option value="200">200条/批（适合高配置服务器）</option>
                                </select>
                                <small class="text-muted">批次越大处理越快，但可能增加服务器负载</small>
                            </div>
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped active" role="progressbar" 
                                     style="width: 0%" id="progressBar">0%</div>
                            </div>
                            <div class="text-center" style="margin-top: 10px;">
                                <span id="progressText">准备开始处理...</span>
                            </div>
                            <div class="text-center" style="margin-top: 5px;">
                                <small class="text-muted" id="estimatedTime">预估剩余时间：计算中...</small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="startBatchProcess()">开始处理</button>
                            <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                        </div>
                        <div class="modal-footer" id="controlButtons" style="display: none;">
                            <button type="button" class="btn btn-warning" onclick="pauseProcess()" id="pauseBtn">暂停</button>
                            <button type="button" class="btn btn-success" onclick="resumeProcess()" id="resumeBtn" style="display: none;">恢复</button>
                            <button type="button" class="btn btn-danger" onclick="stopProcess()">停止</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // 移除已存在的进度对话框
        $('#progressModal').remove();
        $('body').append(progressHtml);
        $('#progressModal').modal('show');
    }
    
    var currentStatus = 1; // 存储当前操作状态
    var isPaused = false; // 是否暂停
    var isStopped = false; // 是否停止
    var currentBatchSize = 50; // 当前批次大小
    var startTime = 0; // 开始时间
    var lastBatchTime = 0; // 上一批处理时间
    
    function autoApproveAll(status = 1) {
        currentStatus = status; // 保存状态
        var actionText = status == 1 ? '通过' : '驳回';
        if (!confirm('确定要一键' + actionText + '所有待审核的兑换申请吗？此操作将自动' + actionText + '所有待审核申请。')) {
            return;
        }
        
        // 重置状态
        isPaused = false;
        isStopped = false;
        startTime = 0;
        lastBatchTime = 0;
        
        // 显示进度对话框
        showProgressDialog();
    }
    
    function startBatchProcess() {
        currentBatchSize = parseInt($('#batchSizeSelect').val());
        $('#progressModal .modal-footer').hide(); // 隐藏开始按钮
        $('#controlButtons').show(); // 显示控制按钮
        startTime = Date.now(); // 记录开始时间
        processBatch(currentStatus, 0, currentBatchSize);
    }
    
    function calculateEstimatedTime(processedCount, totalCount, currentBatch) {
        if (currentBatch <= 1) {
            return '计算中...';
        }
        
        var elapsedTime = Date.now() - startTime;
        var avgTimePerBatch = elapsedTime / (currentBatch - 1);
        var remainingBatches = Math.ceil((totalCount - processedCount) / currentBatchSize);
        var estimatedRemainingTime = remainingBatches * avgTimePerBatch;
        
        if (estimatedRemainingTime < 60000) {
            return Math.ceil(estimatedRemainingTime / 1000) + '秒';
        } else if (estimatedRemainingTime < 3600000) {
            return Math.ceil(estimatedRemainingTime / 60000) + '分钟';
        } else {
            return Math.ceil(estimatedRemainingTime / 3600000) + '小时';
        }
    }
    
    function pauseProcess() {
        isPaused = true;
        $('#pauseBtn').hide();
        $('#resumeBtn').show();
        $('#progressText').text($('#progressText').text() + ' (已暂停)');
    }
    
    function resumeProcess() {
        isPaused = false;
        $('#pauseBtn').show();
        $('#resumeBtn').hide();
        $('#progressText').text($('#progressText').text().replace(' (已暂停)', ''));
        // 继续处理
        processBatch(currentStatus, parseInt($('#progressText').text().match(/第(\d+)批/)[1]), currentBatchSize);
    }
    
    function stopProcess() {
        isStopped = true;
        $('#progressModal').modal('hide');
        Layer.msg('批量处理已停止', {icon: 2});
    }
    
    function processBatch(status, currentBatch, batchSize) {
        // 检查是否已停止
        if (isStopped) {
            return;
        }
        
        // 检查是否暂停
        if (isPaused) {
            return;
        }
        
        $('#loading-overlay').show();
        
        $.ajax({
            type: 'POST',
            url: 'coupon_exchange_newcash/autoApproveAll',
            data: {
                status: status,
                current_batch: currentBatch,
                batch_size: batchSize
            },
            success: function (response) {
                $('#loading-overlay').hide();
                
                // 检查是否已停止
                if (isStopped) {
                    return;
                }
                
                if (response.code == 1) {
                    var data = response.data;
                    
                    // 更新进度条
                    $('#progressBar').css('width', data.progress + '%').text(data.progress + '%');
                    $('#progressText').text('第' + data.current_batch + '批处理完成，共' + data.total_count + '条，已处理' + data.processed_count + '条');
                    
                    // 更新预估时间
                    var estimatedTime = calculateEstimatedTime(data.processed_count, data.total_count, data.current_batch);
                    $('#estimatedTime').text('预估剩余时间：' + estimatedTime);
                    
                    if (data.has_more && !isStopped) {
                        // 还有更多数据需要处理，继续下一批
                        setTimeout(function() {
                            processBatch(status, data.current_batch, batchSize);
                        }, 500); // 延迟500ms避免请求过于频繁
                    } else {
                        // 所有批次处理完成
                        $('#progressModal').modal('hide');
                        $('#table').bootstrapTable('refresh');
                        Layer.msg('批量处理完成！共处理 ' + data.total_count + ' 条记录', {icon: 1});
                    }
                } else {
                    $('#progressModal').modal('hide');
                    Layer.msg(response.msg, {icon: 2});
                }
            },
            error: function (xhr, status, error) {
                $('#loading-overlay').hide();
                if (!isStopped) {
                    $('#progressModal').modal('hide');
                    Layer.msg('操作失败，请重试', {icon: 2});
                }
                console.error('Error:', xhr.responseText);
            }
        });
    }
</script>